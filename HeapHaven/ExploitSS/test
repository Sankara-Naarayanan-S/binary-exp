#!/usr/bin/env python3
"""
Simple test script for Heap Haven challenge
"""

try:
    from pwn import *
except ImportError:
    print("Installing pwntools...")
    import subprocess
    subprocess.check_call(['pip', 'install', 'pwntools'])
    from pwn import *

def test_binary():
    """Test if binary runs and basic functionality works"""
    
    # Try different binary paths
    binary_paths = [
        "../src/heap_haven.exe",  # Windows binary
        "../src/heap_haven",       # Linux binary
        "./src/heap_haven.exe",
        "./src/heap_haven"
    ]
    
    for binary in binary_paths:
        try:
            print(f"Trying binary: {binary}")
            p = process(binary)
            
            # Test allocation
            p.sendline(b"1")  # Allocate
            p.sendline(b"0")  # Index 0
            p.sendline(b"100")  # Size 100
            p.sendline(b"AAAABBBBCCCC")  # Data
            
            # Test view
            p.sendline(b"3")  # View
            p.sendline(b"0")  # Index 0
            
            # Get response
            response = p.recvuntil(b"Data: ", timeout=2)
            data = p.recvline(timeout=2)
            print(f"Received: {data}")
            
            # Exit
            p.sendline(b"5")
            p.close()
            
            print(f"✅ Success with {binary}")
            return binary
            
        except Exception as e:
            print(f"❌ Failed with {binary}: {e}")
            continue
    
    print("❌ No working binary found")
    return None

if __name__ == "__main__":
    print("Testing Heap Haven binary...")
    binary = test_binary()
    if binary:
        print(f"\n✅ Binary works: {binary}")
    else:
        print("\n❌ Please compile a Windows binary first:")
        print("gcc -o src\\heap_haven.exe src\\heap_haven.c -fno-stack-protector -no-pie")